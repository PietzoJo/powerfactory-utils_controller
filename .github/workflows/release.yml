name: release

on: workflow_dispatch

jobs:
  tests:
    uses: ./.github/workflows/tests.yml
  release:
    name: "Releasing a new version"
    runs-on: ubuntu-latest
    needs: [tests]

    steps:
      - name: Checking out repository
        uses: actions/checkout@v3
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          fetch-depth: 0

      - name: Setting up Python 3.9.13
        uses: actions/setup-python@v3
        with:
          python-version: 3.9.13

      - name: Setting up PDM
        uses: pdm-project/setup-pdm@v2.7
        with:
          python-version: 3.9.13
          architecture: x64
          prerelease: true
          enable-pep582: true

      - name: Bumping version and creating changelog
        uses: commitizen-tools/commitizen-action@0.14.1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          changelog_increment_filename: body.md

      - name: Caching PDM __pypackages__
        uses: actions/cache@v3
        id: cache
        with:
          path: __pypackages__
          key: pdm-${{ hashFiles('**/pdm.lock') }}
          restore-keys: |
            pdm-${{ hashFiles('**/pdm.lock') }}

      - name: Building Python packages
        run: pdm build

      - name: Creating release
        uses: softprops/action-gh-release@v1
        with:
          body_path: "body.md"
          tag_name: ${{ env.REVISION }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
